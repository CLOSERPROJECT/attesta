#+TITLE: Backoffice Workflow + Step Labels
#+SUBTITLE: Show workflow name and step title next to process ID
#+DATE: 2026-02-25
#+KEYWORDS: backoffice, templates, workflow, yaml, go, ui

Summary: Add workflow name and “current step” (step title from `server/config/*.yaml`) next to process IDs in `backoffice_department.html` and `backoffice_process.html`, so backoffice users immediately know which workflow and which step a process is currently at.

* DONE [#A] Define “current step” semantics
Effort: S
Goal: Decide which step title to display in each backoffice context.
Notes: Keep semantics simple, stable, and easy to explain; avoid ambiguous “in progress” states.

** DONE [#A] Choose step-title selection rules
Why: “Step title” can mean multiple things (next available step, last completed step, etc.); aligning now prevents inconsistent UI and brittle logic.
Change:
- Department dashboard (per-role):
  - For each *todo action*: use the parent step title of that action’s `SubstepID`.
  - For each *active stream*: use the parent step title of the process’s next available substep *for that role* (same substep used for “Next for you”).
  - For *done streams*: use the last step title in the workflow definition.
- Department process page (single process):
  - Use the parent step title of the process’s next available substep (any role).
  - If the process is `done` (no next substep), use the last step title.
- Fallbacks:
  - If step resolution fails, render workflow name only and omit the step title (do not error the page).
Tests: Add unit tests for at least (a) an active process in step 2 and (b) a done process (final step), using the existing `testRuntimeConfig()` step titles.
Done when: The rules above are written into code as helpers and reflected in templates with predictable output.

* WIP [#A] Expose step titles in backoffice view models
Effort: M
Goal: Compute step titles from `cfg.Workflow.Steps[*].Title` and pass them to templates.
Notes: Prefer minimal/local changes in `server/cmd/server/main.go`; keep existing fields working (`NextSubstep`, `NextTitle`) and add new ones.

** WIP [#A] Add helpers to resolve step title
Why: Step-title lookup will be used in multiple places (role todos, process summaries, process page header).
Change:
- In `server/cmd/server/main.go`, add small pure helpers (no new deps):
  - `stepTitleForSubstep(def WorkflowDef, substepID string) (title string, ok bool)` (can reuse `findSubstep`).
  - `nextAvailableSubstepWithStep(def WorkflowDef, process *Process) (sub WorkflowSub, step WorkflowStep, ok bool)` by scanning `sortedSteps/ sortedSubsteps` and `computeAvailability`.
  - `nextAvailableSubstepForRoleWithStep(def WorkflowDef, process *Process, role string) (sub WorkflowSub, step WorkflowStep, ok bool)` similarly.
  - `lastStepTitle(def WorkflowDef) (title string, ok bool)` (use `sortedSteps` and take last).
Tests: Unit test helpers directly (fast), and/or cover via handler/template rendering tests below.
Done when: Helpers return correct step titles for the seeded “active in step 2” and “done in step 3” fixtures.

** TODO [#A] Extend dashboard/process DTOs with step titles
Why: Templates can only render what the view models provide.
Change:
- In `server/cmd/server/main.go`:
  - Extend `ActionTodo` with `StepTitle string` (optional: also `StepID` if you want “2 — Step 2” formatting).
  - Extend `ProcessSummary` with `StepTitle string` (for active/done lists), or `NextStepTitle string` if you prefer explicitness.
  - Extend `DepartmentProcessView` with `CurrentStepTitle string` (optional: `CurrentStepID string`).
Tests: Compile-time coverage via existing tests; add assertions in new tests that step title is present for the seeded processes.
Done when: Handlers build views with non-empty step titles where expected.

** TODO [#A] Wire step titles into existing builders/handlers
Why: The data is currently computed only at substep granularity (`NextTitle`, todo substep `Title`).
Change:
- Update `buildRoleTodos(...)` to iterate steps/substeps (not only `orderedSubsteps`) so it can attach `StepTitle` while creating `ActionTodo`.
- Update `buildProcessSummaryForRole(...)` (and/or `nextAvailableSubstepForRole`) to attach step title alongside `NextSubstep/NextTitle`.
- In `handleDepartmentProcess(...)` and `renderDepartmentProcessPage(...)`, compute `CurrentStepTitle` using the “any role” next-substep helper, with `done -> lastStepTitle`.
Tests: Add a regression test that `handleBackoffice` for `/backoffice/dep2/process/{activeID}` renders a header including `Demo workflow` and `Step 2`.
Done when: Both dashboard and process page views have step titles derived from the YAML workflow definition.

* TODO [#B] Render workflow + step near process ID in templates
Effort: S
Goal: Update the two templates to show `WorkflowName` and the computed step title next to the process ID.
Notes: Keep markup minimal; reuse existing classes (`muted`, `process-head`) to avoid CSS churn.

** TODO [#B] Update `server/templates/backoffice_department.html`
Why: The dashboard lists many processes; adding context next to the ID reduces navigation and confusion in multi-workflow setups.
Change:
- In “Things to do”, “Active streams”, and “Previous history”:
  - In `.process-head`, render something like: `{{.ProcessID}} — {{$.WorkflowName}} — {{.StepTitle}}` (field name depends on DTO choice).
  - Keep the existing second line showing substep id + substep title (“1.2 - Attach batch ID”) as-is; it complements the step title.
Tests: Template-rendering test should assert the HTML contains process id + workflow name + expected step title.
Done when: Each process list item shows workflow and step information adjacent to the ID link.

** TODO [#B] Update `server/templates/backoffice_process.html`
Why: The per-process view header currently shows only the process id; workflow + step improves user orientation.
Change:
- Extend the header line under “{{.RoleLabel}} actions” to include:
  - Workflow name: `{{.WorkflowName}}`
  - Current step title: `{{.CurrentStepTitle}}` (with graceful omission if empty)
Tests: Template-rendering test should assert the response includes `Demo workflow` and `Step 2` for the active fixture.
Done when: The process page header consistently shows process id + workflow + step.

* TODO [#B] Add/adjust tests to lock in behavior
Effort: S
Goal: Ensure regressions are caught when templates or step-resolution logic changes.
Notes: Prefer tests that parse real templates (`server/templates/*.html`) for confidence; keep assertions flexible (substring-based).

** TODO [#B] Add integration-style unit test rendering real templates
Why: The current `testTemplates()` shortcuts don’t validate actual HTML templates.
Change:
- Add a new test file (e.g. `server/cmd/server/backoffice_templates_render_test.go`) that:
  - Parses `server/templates/*.html` via `template.ParseGlob`.
  - Uses `MemoryStore` + `seedBackofficeFixtures` + `testRuntimeConfig`.
  - Calls `handleBackoffice` for:
    - `/backoffice/dep2` and asserts it includes `Demo workflow` and `Step 2`.
    - `/backoffice/dep2/process/{activeID}` and asserts it includes `Demo workflow` and `Step 2`.
  - Optionally asserts done process includes `Step 3` (last step title).
Tests: Run `go test ./...` (and `task test` in CI) to ensure no breakage.
Done when: Tests fail on missing workflow/step labels and pass when labels render.

* TODO [#C] Manual verification checklist
Effort: XS
Goal: Confirm UX in the browser across real workflow configs under `server/config/*.yaml`.
Notes: Include at least two workflows to ensure the workflow name is meaningful.

** TODO [#C] Smoke-test pages with multiple workflows
Why: The feature is primarily for human orientation; visual confirmation is valuable.
Change:
- Start the app with at least 2 workflow configs available.
- Visit:
  - `/w/<key>/backoffice/<role>` and confirm list items show “WorkflowName — StepTitle” near IDs.
  - `/w/<key>/backoffice/<role>/process/<id>` and confirm header shows “ProcessID — WorkflowName — StepTitle”.
Tests: N/A (manual).
Done when: Labels render correctly for active and done processes and do not break existing navigation.
